<?php

use App\Models\Sale;
use App\Models\SaleTicketEntry;
use App\Models\Event;

beforeEach(function () {
    \Illuminate\Support\Facades\Log::spy();
});

it('scans entry secret successfully', function () {
    $event = Event::factory()->create(['starts_at' => now()->addDays(1)]);
    $sale = Sale::factory()->create(['secret' => 'sale-ABC', 'event_id' => $event->id]);
    $entry = SaleTicketEntry::factory()->create(['secret' => 'entry-123', 'sale_id' => $sale->id]);

    $response = $this->postJson('/api/tickets/scan', ['code' => 'entry-123', 'location' => 'door-1']);

    $response->assertStatus(200);

    \Illuminate\Support\Facades\Log::shouldHaveReceived('info')->withArgs(function ($message, $context) use ($entry, $sale) {
        return $message === 'scan_by_code: entry_found' && isset($context['entry_id']) && $context['entry_id'] === $entry->id && isset($context['sale_id']) && $context['sale_id'] === $sale->id;
    });
});

it('falls back to sale secret when entry missing', function () {
    $event = Event::factory()->create(['starts_at' => now()->addDays(1)]);
    $sale = Sale::factory()->create(['secret' => 'sale-ABC', 'event_id' => $event->id]);

    $response = $this->postJson('/api/tickets/scan', ['code' => 'sale-ABC', 'location' => 'door-1']);

    $response->assertStatus(200);

    \Illuminate\Support\Facades\Log::shouldHaveReceived('info')->withArgs(function ($message, $context) use ($sale) {
        return $message === 'scan_by_code: created_entry' && isset($context['sale_id']) && $context['sale_id'] === $sale->id;
    });
});

it('rejects scan outside event time based on event timezone', function () {
    $event = Event::factory()->create(['starts_at' => now()->subDays(10)]);
    $sale = Sale::factory()->create(['secret' => 'old-sale', 'event_id' => $event->id]);

    $response = $this->postJson('/api/tickets/scan', ['code' => 'old-sale', 'location' => 'door-1']);

    $response->assertStatus(400);

    \Illuminate\Support\Facades\Log::shouldHaveReceived('info')->withArgs(function ($message, $context) use ($sale) {
        return $message === 'scan_by_code: date_mismatch' && isset($context['sale_id']) && $context['sale_id'] === $sale->id;
    });
});

it('logs not found for invalid code', function () {
    $response = $this->postJson('/api/tickets/scan', ['code' => 'invalid-xyz', 'location' => 'door']);

    $response->assertStatus(404);

    \Illuminate\Support\Facades\Log::shouldHaveReceived('info')->withArgs(function ($message, $context) {
        return $message === 'scan_by_code: not_found' && isset($context['code']) && $context['code'] === 'invalid-xyz';
    });
});
