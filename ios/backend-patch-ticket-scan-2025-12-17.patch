diff --git a/app/Http/Controllers/Api/ApiTicketController.php b/app/Http/Controllers/Api/ApiTicketController.php
index 0000000..0000000 100644
--- a/app/Http/Controllers/Api/ApiTicketController.php
+++ b/app/Http/Controllers/Api/ApiTicketController.php
@@ public function scanByCode(Request $request)
-    public function scanByCode(Request $request)
-    {
-        $validated = $request->validate([
-            'ticket_code' => ['required', 'string'],
-            'sale_ticket_id' => ['nullable', 'integer'],
-            'seat_number' => ['nullable', 'string', 'max:255'],
-        ]);
-
-        // Lookup sale by secret (ticket code)
-        $sale = Sale::with(['event', 'saleTickets.ticket', 'saleTickets.entries'])
-            ->where('secret', $validated['ticket_code'])
-            ->where('is_deleted', false)
-            ->first();
-
-        if (!$sale) {
-            return response()->json(['error' => 'Ticket not found'], 404);
-        }
-
-        // Check if user manages this event
-        $user = $request->user();
-        if (!$user->canEditEvent($sale->event)) {
-            return response()->json(['error' => 'You are not authorized to scan this ticket'], 403);
-        }
-
-        // Validation: Ticket must be for today
-        if (Carbon::parse($sale->event_date)->format('Y-m-d') !== now()->format('Y-m-d')) {
-            return response()->json(['error' => 'This ticket is not valid for today'], 400);
-        }
-
-        // Validation: Ticket must be paid
-        if ($sale->status === 'unpaid') {
-            return response()->json(['error' => 'This ticket is not paid'], 400);
-        } elseif ($sale->status === 'cancelled') {
-            return response()->json(['error' => 'This ticket is cancelled'], 400);
-        } elseif ($sale->status === 'refunded') {
-            return response()->json(['error' => 'This ticket is refunded'], 400);
-        }
-
-        // Determine which sale_ticket to scan
-        if (isset($validated['sale_ticket_id'])) {
-            $saleTicket = $sale->saleTickets->firstWhere('id', $validated['sale_ticket_id']);
-            if (!$saleTicket) {
-                return response()->json(['error' => 'Sale ticket not found'], 404);
-            }
-        } else {
-            // Default to first sale ticket
-            $saleTicket = $sale->saleTickets->first();
-            if (!$saleTicket) {
-                return response()->json(['error' => 'No tickets found in this sale'], 404);
-            }
-        }
-
-        // Create entry and mark as scanned
-        $entry = SaleTicketEntry::create([
-            'sale_ticket_id' => $saleTicket->id,
-            'secret' => Str::random(24),
-            'seat_number' => $validated['seat_number'] ?? null,
-            'scanned_at' => now(),
-        ]);
-
-        // Reload to get fresh usage status
-        $sale->load(['saleTickets.entries']);
-
-        return response()->json([
-            'data' => [
-                'sale_id' => $sale->id,
-                'entry_id' => $entry->id,
-                'scanned_at' => $entry->scanned_at->toIsoString(),
-                'sale' => [
-                    'id' => $sale->id,
-                    'status' => $sale->status,
-                    'name' => $sale->name,
-                    'email' => $sale->email,
-                    'event_id' => $sale->event_id,
-                    'event' => $sale->event ? $sale->event->toApiData() : null,
-                    'tickets' => $sale->saleTickets->map(function ($st) {
-                        return [
-                            'id' => $st->id,
-                            'ticket_id' => $st->ticket_id,
-                            'quantity' => $st->quantity,
-                            'usage_status' => $st->usage_status ?? $st->getUsageStatusAttribute(),
-                        ];
-                    })->all(),
-                ],
-            ],
-        ], 201, [], JSON_PRETTY_PRINT);
-    }
+    public function scanByCode(Request $request)
+    {
+        $validated = $request->validate([
+            'ticket_code' => ['required', 'string'],
+            'sale_ticket_id' => ['nullable', 'integer'],
+            'seat_number' => ['nullable', 'string', 'max:255'],
+        ]);
+
+        $code = $validated['ticket_code'];
+
+        // Try entry secret first
+        $entry = SaleTicketEntry::with('saleTicket.sale.event')
+            ->where('secret', $code)
+            ->first();
+
+        $sale = $entry?->saleTicket?->sale;
+
+        // Fallback to sale secret
+        if (!$sale) {
+            $sale = Sale::with(['event', 'saleTickets.ticket', 'saleTickets.entries'])
+                ->where('secret', $code)
+                ->where('is_deleted', false)
+                ->first();
+        }
+
+        if (!$sale) {
+            return response()->json(['error' => 'Ticket not found'], 404);
+        }
+
+        // Authorization
+        $user = $request->user();
+        if (!$user->canEditEvent($sale->event)) {
+            return response()->json(['error' => 'You are not authorized to scan this ticket'], 403);
+        }
+
+        // Validate event date in event timezone
+        $tz = $sale->event->timezone ?: config('app.timezone', 'UTC');
+        $eventDateLocal = Carbon::parse($sale->event_date, 'UTC')->setTimezone($tz)->toDateString();
+        $todayLocal = now($tz)->toDateString();
+        if ($eventDateLocal !== $todayLocal) {
+            return response()->json(['error' => 'This ticket is not valid for today'], 400);
+        }
+
+        // Payment/status validation
+        if ($sale->status === 'unpaid') {
+            return response()->json(['error' => 'This ticket is not paid'], 400);
+        } elseif ($sale->status === 'cancelled') {
+            return response()->json(['error' => 'This ticket is cancelled'], 400);
+        } elseif ($sale->status === 'refunded') {
+            return response()->json(['error' => 'This ticket is refunded'], 400);
+        }
+
+        // If we matched by entry secret, mark it scanned (idempotent)
+        if ($entry) {
+            if (!$entry->scanned_at) {
+                $entry->scanned_at = now('UTC');
+                $entry->save();
+            }
+
+            $sale->load(['saleTickets.entries']);
+
+            return response()->json([
+                'data' => [
+                    'sale_id' => $sale->id,
+                    'entry_id' => $entry->id,
+                    'scanned_at' => $entry->scanned_at->toIsoString(),
+                    'sale' => [
+                        'id' => $sale->id,
+                        'status' => $sale->status,
+                        'name' => $sale->name,
+                        'email' => $sale->email,
+                        'event_id' => $sale->event_id,
+                        'event' => $sale->event ? $sale->event->toApiData() : null,
+                        'tickets' => $sale->saleTickets->map(function ($st) {
+                            return [
+                                'id' => $st->id,
+                                'ticket_id' => $st->ticket_id,
+                                'quantity' => $st->quantity,
+                                'usage_status' => $st->getUsageStatusAttribute(),
+                            ];
+                        })->values()->all(),
+                    ],
+                ],
+            ], 201, [], JSON_PRETTY_PRINT);
+        }
+
+        // Otherwise (sale secret), determine sale ticket to scan
+        if (isset($validated['sale_ticket_id'])) {
+            $saleTicket = $sale->saleTickets->firstWhere('id', $validated['sale_ticket_id']);
+            if (!$saleTicket) {
+                return response()->json(['error' => 'Sale ticket not found'], 404);
+            }
+        } else {
+            $saleTicket = $sale->saleTickets->first();
+            if (!$saleTicket) {
+                return response()->json(['error' => 'No tickets found in this sale'], 404);
+            }
+        }
+
+        // Create a new entry for this scan
+        $newEntry = SaleTicketEntry::create([
+            'sale_ticket_id' => $saleTicket->id,
+            'secret' => Str::random(24),
+            'seat_number' => $validated['seat_number'] ?? null,
+            'scanned_at' => now(),
+        ]);
+
+        $sale->load(['saleTickets.entries']);
+
+        return response()->json([
+            'data' => [
+                'sale_id' => $sale->id,
+                'entry_id' => $newEntry->id,
+                'scanned_at' => $newEntry->scanned_at->toIsoString(),
+                'sale' => [
+                    'id' => $sale->id,
+                    'status' => $sale->status,
+                    'name' => $sale->name,
+                    'email' => $sale->email,
+                    'event_id' => $sale->event_id,
+                    'event' => $sale->event ? $sale->event->toApiData() : null,
+                    'tickets' => $sale->saleTickets->map(function ($st) {
+                        return [
+                            'id' => $st->id,
+                            'ticket_id' => $st->ticket_id,
+                            'quantity' => $st->quantity,
+                            'usage_status' => $st->getUsageStatusAttribute(),
+                        ];
+                    })->values()->all(),
+                ],
+            ],
+        ], 201, [], JSON_PRETTY_PRINT);
+    }
@@ public function index(Request $request)
-        // Optional: filter by query (name or email)
-        if ($request->filled('query')) {
-            $searchTerm = $request->string('query')->trim()->value();
-            $query->where(function ($q) use ($searchTerm) {
-                $q->where('name', 'like', "%{$searchTerm}%")
-                  ->orWhere('email', 'like', "%{$searchTerm}%");
-            });
-        }
+        // Optional: filter by query (name/email/secret/entry secret)
+        if ($request->filled('query')) {
+            $searchTerm = $request->string('query')->trim()->value();
+            $query->where(function ($q) use ($searchTerm) {
+                $q->where('name', 'like', "%{$searchTerm}%")
+                  ->orWhere('email', 'like', "%{$searchTerm}%")
+                  ->orWhere('secret', 'like', "%{$searchTerm}%")
+                  ->orWhereHas('saleTickets.entries', function ($e) use ($searchTerm) {
+                      $e->where('secret', 'like', "%{$searchTerm}%");
+                  });
+            });
+        }
